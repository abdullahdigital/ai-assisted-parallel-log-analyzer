---
import './ThreatDetections.css';
---

<section class="live-feed-section">
  <div class="feed-header">
    <div class="feed-title">GENERATED ALERTS</div>
    <div class="feed-status">
      <div class="alert-count" id="total-alerts-count">0</div>
      <span>TOTAL</span>
    </div>
  </div>
  <div class="feed-content">
    <table class="alerts-table">
      <thead>
        <tr>
          <th></th>
          <th>TIME</th>
          <th>SEVERITY</th>
          <th>MESSAGE</th>
          <th>ACTIONS</th>
        </tr>
      </thead>
      <tbody id="alerts-table-body">
        <!-- Alert rows will be injected here by JavaScript -->
      </tbody>
    </table>
  </div>

  <!-- Modal for Raw Log Data -->
  <div id="raw-log-modal" class="modal">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>Raw Log Data</h2>
      <pre id="raw-log-display"></pre>
    </div>
  </div>
</section>

<script>
  // Function to generate a random log entry for demonstration
  const generateRandomLog = () => {
    const severities = ['CRITICAL', 'WARNING', 'INFO', 'SECURITY'];
    const messages = [
      'Multiple failed login attempts',
      'Unusual file access pattern',
      'Database injection attempt',
      'Configuration change detected',
      'Port scanning detected',
      'High memory usage alert',
      'Unauthorized access attempt',
      'SQL Injection attempt detected'
    ];
    const rawLogs = [
      '[2024-01-15 12:45:24] host=webserver.com user=admin status=failed attempts=5 source=192.168.1.1 CRITICAL: Multiple failed login attempts',
      '[2024-01-15 12:44:58] host=fileserver.net user=guest path=/var/www/html/data/ access_type=read WARNING: Unusual file access pattern',
      '[2024-01-15 12:44:32] host=db.internal query="SELECT * FROM users WHERE id=\'1 OR 1=1--\'" CRITICAL: Database injection attempt',
      '[2024-01-15 12:43:45] host=appserver.io user=system config=updated INFO: Configuration change detected',
      '[2024-01-15 12:43:12] host=firewall.local target=10.0.0.0/8 type=SYN_SCAN CRITICAL: Port scanning detected',
      '[2024-01-15 12:42:38] host=monitor.cloud service=backend memory_usage=95% WARNING: High memory usage alert',
      '[2024-01-15 12:41:01] host=proxy.edge user=unknown ip=10.0.0.5 action=blocked SECURITY: Unauthorized access attempt',
      '[2024-01-15 12:40:10] host=api.gateway payload="DROP TABLE users;" SECURITY: SQL Injection attempt detected'
    ];

    const severity = severities[Math.floor(Math.random() * severities.length)];
    const message = messages[Math.floor(Math.random() * messages.length)];
    const rawLog = rawLogs[Math.floor(Math.random() * rawLogs.length)];
    const timestamp = new Date().toLocaleTimeString();

    return {
      id: Date.now(),
      time: timestamp,
      severity: severity,
      message: message,
      raw: rawLog
    };
  };

  // Function to render alerts into the table
  const renderAlerts = (alerts) => {
    const alertsTableBody = document.getElementById('alerts-table-body');
    const totalAlertsCount = document.getElementById('total-alerts-count');
    
    if (!alertsTableBody || !totalAlertsCount) return;
    
    alertsTableBody.innerHTML = '';
    alerts.forEach(alert => {
      const row = document.createElement('tr');
      row.classList.add('alert-row');
      row.innerHTML = `
        <td class="expand-toggle"><svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></td>
        <td>${alert.time}</td>
        <td><span class="severity-badge ${alert.severity.toLowerCase()}">${alert.severity}</span></td>
        <td>${alert.message}</td>
        <td><button class="view-raw-btn" data-raw-log="${alert.raw.replace(/"/g, '&quot;')}">View Raw</button></td>
      `;
      alertsTableBody.appendChild(row);

      const expandableRow = document.createElement('tr');
      expandableRow.classList.add('expandable-content');
      expandableRow.innerHTML = `
        <td colspan="5">
          <div class="expanded-details">
            <strong>Rule Matched:</strong> Suspicious Activity Detection v1.2<br>
            <strong>Source IP:</strong> 192.168.1.1<br>
            <strong>User Agent:</strong> Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36
          </div>
        </td>
      `;
      alertsTableBody.appendChild(expandableRow);
    });
    totalAlertsCount.textContent = alerts.length;
  };

  document.addEventListener('DOMContentLoaded', () => {
    const alertsTableBody = document.getElementById('alerts-table-body');
    const totalAlertsCount = document.getElementById('total-alerts-count');
    const rawLogModal = document.getElementById('raw-log-modal');
    const closeModalButton = rawLogModal?.querySelector('.close-button');
    const rawLogDisplay = document.getElementById('raw-log-display');

    if (!alertsTableBody || !totalAlertsCount) {
      console.error('Required DOM elements not found');
      return;
    }

    let alerts = [];

    // Event listener for expandable rows
    alertsTableBody.addEventListener('click', (event) => {
      const target = event.target;
      const row = target.closest('.alert-row');
      if (row) {
        const expandableContent = row.nextElementSibling;
        if (expandableContent && expandableContent.classList.contains('expandable-content')) {
          row.classList.toggle('expanded');
          expandableContent.classList.toggle('active');
          
          const svgElement = target.closest('.expand-toggle')?.querySelector('svg');
          if (svgElement) {
            svgElement.classList.toggle('rotated');
          }
        }
      }

      // Event listener for View Raw button
      if (target.classList.contains('view-raw-btn')) {
        const rawLog = target.dataset.rawLog;
        if (rawLogDisplay) {
          rawLogDisplay.textContent = rawLog;
        }
        if (rawLogModal) {
          rawLogModal.style.display = 'block';
        }
      }
    });

    // Close modal
    if (closeModalButton && rawLogModal) {
      closeModalButton.addEventListener('click', () => {
        rawLogModal.style.display = 'none';
      });
    }

    if (rawLogModal) {
      window.addEventListener('click', (event) => {
        if (event.target === rawLogModal) {
          rawLogModal.style.display = 'none';
        }
      });
    }

    // Add a new alert every few seconds for demonstration
    setInterval(() => {
      const newAlert = generateRandomLog();
      alerts.unshift(newAlert); // Add to the beginning
      if (alerts.length > 10) {
        alerts.pop(); // Keep only the latest 10 alerts
      }
      renderAlerts(alerts);
    }, 3000);

    // Initial render
    for (let i = 0; i < 5; i++) {
      alerts.push(generateRandomLog());
    }
    renderAlerts(alerts);
  });
</script>